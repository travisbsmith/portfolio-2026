---
import BaseLayout from '../layouts/BaseLayout.astro';
import * as fs from 'fs';
import * as path from 'path';

// Load analytics cache at build time
let analyticsData: any = null;
try {
  const cachePath = path.join(process.cwd(), 'src/data/analytics-cache.json');
  if (fs.existsSync(cachePath)) {
    analyticsData = JSON.parse(fs.readFileSync(cachePath, 'utf-8'));
  }
} catch (e) {
  console.error('Could not load analytics cache:', e);
}

// Load posts cache at build time
let postsData: any = null;
try {
  const postsCachePath = path.join(process.cwd(), 'src/data/posts-cache.json');
  if (fs.existsSync(postsCachePath)) {
    postsData = JSON.parse(fs.readFileSync(postsCachePath, 'utf-8'));
  }
} catch (e) {
  console.error('Could not load posts cache:', e);
}
---

<BaseLayout title="Analytics Dashboard ‚Äî Travis Smith" description="Private analytics dashboard">
  <div id="auth-screen" class="auth-screen">
    <div class="auth-card">
      <h1>Analytics Dashboard</h1>
      <p>Enter password to access</p>
      <form id="auth-form">
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
        <button type="submit">Access Dashboard</button>
      </form>
      <p id="auth-error" class="error"></p>
    </div>
  </div>

  <div id="dashboard" class="dashboard" style="display: none;">
    <header class="dashboard-header">
      <div class="container">
        <div class="header-content">
          <div>
            <a href="/" class="back-link">&larr; Back to site</a>
            <h1>Analytics Dashboard</h1>
          </div>
          <div class="header-actions">
            <select id="date-range">
              <option value="24h">Last 24 hours</option>
              <option value="7d" selected>Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="90d">Last 90 days</option>
            </select>
            <button id="logout-btn" class="btn-secondary">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
          <span id="last-updated">
            Data as of: {analyticsData ? new Date(analyticsData.lastSynced).toLocaleString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' }) : 'No data yet'}
          </span>
          <span class="status-note">Updates with each site build (daily at 6 AM UTC)</span>
        </div>

        <!-- Key Metrics -->
        <section class="metrics-grid" id="key-metrics">
          {analyticsData && Object.entries(analyticsData.periods).map(([period, data]: [string, any]) => (
            <div class={`period-data ${period === '7d' ? '' : 'hidden'}`} data-period={period}>
              <div class="metrics-grid--inner">
                <div class="metric-card">
                  <div class="metric-label">Total Views</div>
                  <div class="metric-value">{data.pageviews.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Unique Visitors</div>
                  <div class="metric-value">{data.visitors.toLocaleString()}</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Bounce Rate</div>
                  <div class="metric-value">{data.visits > 0 ? Math.round(data.bounces / data.visits * 100) : 0}%</div>
                </div>
                <div class="metric-card">
                  <div class="metric-label">Avg. Visit Duration</div>
                  <div class="metric-value">
                    {data.visits > 0 
                      ? `${Math.floor(data.totaltime / data.visits / 60)}m ${Math.round(data.totaltime / data.visits % 60)}s`
                      : '0s'}
                  </div>
                </div>
              </div>
            </div>
          ))}
          {!analyticsData && (
            <div class="metrics-grid--inner">
              <div class="metric-card"><div class="metric-label">Total Views</div><div class="metric-value">0</div></div>
              <div class="metric-card"><div class="metric-label">Unique Visitors</div><div class="metric-value">0</div></div>
              <div class="metric-card"><div class="metric-label">Bounce Rate</div><div class="metric-value">0%</div></div>
              <div class="metric-card"><div class="metric-label">Avg. Visit Duration</div><div class="metric-value">0s</div></div>
            </div>
          )}
        </section>

        <!-- LLM Traffic Section -->
        <section class="section">
          <h2>ü§ñ AI/LLM Traffic</h2>
          <div class="metrics-grid--inner metrics-grid--3">
            {(() => {
              const pages = analyticsData?.pages || [];
              const llmsTxt = pages.find((p: any) => p.x === '/llms.txt')?.y || 0;
              const llmsFull = pages.find((p: any) => p.x === '/llms-full.txt')?.y || 0;
              const blogMd = pages.filter((p: any) => p.x.endsWith('.md')).reduce((sum: number, p: any) => sum + p.y, 0);
              return (
                <>
                  <div class="metric-card metric-card--highlight">
                    <div class="metric-label">llms.txt Views</div>
                    <div class="metric-value">{llmsTxt}</div>
                  </div>
                  <div class="metric-card metric-card--highlight">
                    <div class="metric-label">Blog .md Views</div>
                    <div class="metric-value">{blogMd}</div>
                  </div>
                  <div class="metric-card metric-card--highlight">
                    <div class="metric-label">llms-full.txt Views</div>
                    <div class="metric-value">{llmsFull}</div>
                  </div>
                </>
              );
            })()}
          </div>
        </section>

        <!-- Two Column Layout -->
        <div class="two-column">
          <!-- Top Pages -->
          <section class="section">
            <h2>Top Pages</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Page</th>
                    <th>Views</th>
                  </tr>
                </thead>
                <tbody>
                  {(analyticsData?.pages || []).length > 0 ? (
                    (analyticsData.pages as any[]).slice(0, 10).map((p: any) => (
                      <tr>
                        <td>{p.x}</td>
                        <td>{p.y}</td>
                      </tr>
                    ))
                  ) : (
                    <tr><td colspan="2" class="empty">No data yet - check back after some traffic</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>

          <!-- Referrers -->
          <section class="section">
            <h2>Top Referrers</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody>
                  {(analyticsData?.referrers || []).length > 0 ? (
                    (analyticsData.referrers as any[]).slice(0, 10).map((r: any) => (
                      <tr>
                        <td>{r.x || '(direct)'}</td>
                        <td>{r.y}</td>
                      </tr>
                    ))
                  ) : (
                    <tr><td colspan="2" class="empty">No referrer data yet</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- More Stats -->
        <div class="two-column">
          <!-- Countries -->
          <section class="section">
            <h2>Countries</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody>
                  {(analyticsData?.countries || []).length > 0 ? (
                    (analyticsData.countries as any[]).slice(0, 10).map((c: any) => (
                      <tr>
                        <td>{c.x}</td>
                        <td>{c.y}</td>
                      </tr>
                    ))
                  ) : (
                    <tr><td colspan="2" class="empty">No country data yet</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>

          <!-- Devices -->
          <section class="section">
            <h2>Devices</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody>
                  {(analyticsData?.devices || []).length > 0 ? (
                    (analyticsData.devices as any[]).slice(0, 5).map((d: any) => (
                      <tr>
                        <td>{d.x}</td>
                        <td>{d.y}</td>
                      </tr>
                    ))
                  ) : (
                    <tr><td colspan="2" class="empty">No device data yet</td></tr>
                  )}
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Substack Stats -->
        <section class="section">
          <h2>üìù Substack Posts</h2>
          <div class="substack-stats">
            <div class="metric-card">
              <div class="metric-label">Total Posts</div>
              <div class="metric-value">{postsData?.posts?.length || 0}</div>
            </div>
            <div class="substack-posts">
              {postsData?.posts?.slice(0, 5).map((post: any) => (
                <div class="substack-post">
                  <span class="substack-post-title">{post.title}</span>
                  <span class="substack-post-date">{new Date(post.date).toLocaleDateString()}</span>
                </div>
              )) || <p class="empty">No posts synced yet</p>}
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
</BaseLayout>

<style>
  /* Auth Screen */
  .auth-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-alt);
  }

  .auth-card {
    background: var(--color-bg);
    padding: var(--space-12);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    text-align: center;
    max-width: 400px;
    width: 100%;
  }

  .auth-card h1 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-2);
  }

  .auth-card p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .auth-card form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .auth-card input {
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: inherit;
  }

  .auth-card button {
    padding: var(--space-3) var(--space-6);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--duration-fast) var(--ease);
  }

  .auth-card button:hover {
    background: var(--color-accent-hover);
  }

  .error {
    color: #e53e3e;
    font-size: var(--text-sm);
    margin-top: var(--space-4);
  }

  /* Dashboard */
  .dashboard {
    min-height: 100vh;
    background: var(--color-bg-alt);
  }

  .dashboard-header {
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-6) 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .back-link {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .header-content h1 {
    font-size: var(--text-2xl);
    margin-top: var(--space-2);
  }

  .header-actions {
    display: flex;
    gap: var(--space-3);
    align-items: center;
  }

  .header-actions select {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: inherit;
    font-size: var(--text-sm);
    background: var(--color-bg);
    cursor: pointer;
  }

  .btn-secondary {
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: inherit;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease);
  }

  .btn-secondary:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .dashboard-main {
    padding: var(--space-8) 0;
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-6);
  }

  .status-note {
    color: var(--color-text-tertiary);
  }

  /* Metrics Grid */
  .metrics-grid {
    margin-bottom: var(--space-8);
  }

  .metrics-grid--inner {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
  }

  .metrics-grid--3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .period-data {
    display: none;
  }

  .period-data.active {
    display: block;
  }

  .hidden {
    display: none;
  }

  @media (max-width: 900px) {
    .metrics-grid--inner {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 500px) {
    .metrics-grid--inner {
      grid-template-columns: 1fr;
    }
  }

  .metric-card {
    background: var(--color-bg);
    padding: var(--space-6);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }

  .metric-card--highlight {
    border-color: var(--color-accent);
    border-width: 2px;
  }

  .metric-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-2);
  }

  .metric-value {
    font-size: var(--text-3xl);
    font-weight: 600;
    color: var(--color-text);
  }

  /* Sections */
  .section {
    background: var(--color-bg);
    padding: var(--space-6);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin-bottom: var(--space-6);
  }

  .section h2 {
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
  }

  .two-column {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  @media (max-width: 768px) {
    .two-column {
      grid-template-columns: 1fr;
    }
  }

  /* Tables */
  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
  }

  th, td {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  th {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-tertiary);
    font-weight: 500;
  }

  td {
    color: var(--color-text);
  }

  td:last-child {
    text-align: right;
    font-family: var(--font-mono);
  }

  th:last-child {
    text-align: right;
  }

  .empty {
    color: var(--color-text-tertiary);
    font-style: italic;
  }

  /* Substack Stats */
  .substack-stats {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: var(--space-6);
    align-items: start;
  }

  @media (max-width: 600px) {
    .substack-stats {
      grid-template-columns: 1fr;
    }
  }

  .substack-posts {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .substack-post {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--color-bg-alt);
    border-radius: var(--radius-sm);
  }

  .substack-post-title {
    font-weight: 500;
  }

  .substack-post-date {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
  }
</style>

<script>
  const DASHBOARD_PASSWORD = 'travis2026';
  const AUTH_KEY = 'portfolio_dashboard_auth';

  const authScreen = document.getElementById('auth-screen')!;
  const dashboard = document.getElementById('dashboard')!;
  const authForm = document.getElementById('auth-form')!;
  const authError = document.getElementById('auth-error')!;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const dateRange = document.getElementById('date-range') as HTMLSelectElement;
  const logoutBtn = document.getElementById('logout-btn')!;

  function checkAuth(): boolean {
    return sessionStorage.getItem(AUTH_KEY) === 'true';
  }

  function initAuth() {
    if (checkAuth()) {
      showDashboard();
    } else {
      authScreen.style.display = 'flex';
      dashboard.style.display = 'none';
    }
  }

  authForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (passwordInput.value === DASHBOARD_PASSWORD) {
      sessionStorage.setItem(AUTH_KEY, 'true');
      showDashboard();
    } else {
      authError.textContent = 'Incorrect password';
      passwordInput.value = '';
    }
  });

  logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem(AUTH_KEY);
    authScreen.style.display = 'flex';
    dashboard.style.display = 'none';
    passwordInput.value = '';
    authError.textContent = '';
  });

  function showDashboard() {
    authScreen.style.display = 'none';
    dashboard.style.display = 'block';
    // Show the default period (7d)
    switchPeriod('7d');
  }

  // Period switcher
  function switchPeriod(period: string) {
    document.querySelectorAll('.period-data').forEach(el => {
      el.classList.remove('active');
    });
    const target = document.querySelector(`.period-data[data-period="${period}"]`);
    if (target) {
      target.classList.add('active');
    }
  }

  dateRange.addEventListener('change', () => {
    switchPeriod(dateRange.value);
  });

  initAuth();
</script>
