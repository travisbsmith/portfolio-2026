---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="Analytics Dashboard ‚Äî Travis Smith" description="Private analytics dashboard">
  <div id="auth-screen" class="auth-screen">
    <div class="auth-card">
      <h1>Analytics Dashboard</h1>
      <p>Enter password to access</p>
      <form id="auth-form">
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
        <button type="submit">Access Dashboard</button>
      </form>
      <p id="auth-error" class="error"></p>
    </div>
  </div>

  <div id="dashboard" class="dashboard" style="display: none;">
    <header class="dashboard-header">
      <div class="container">
        <div class="header-content">
          <div>
            <a href="/" class="back-link">‚Üê Back to site</a>
            <h1>Analytics Dashboard</h1>
          </div>
          <div class="header-actions">
            <select id="date-range">
              <option value="24h">Last 24 hours</option>
              <option value="7d" selected>Last 7 days</option>
              <option value="30d">Last 30 days</option>
              <option value="90d">Last 90 days</option>
            </select>
            <button id="refresh-btn" class="btn-secondary">‚Üª Refresh</button>
            <button id="logout-btn" class="btn-secondary">Logout</button>
          </div>
        </div>
      </div>
    </header>

    <main class="dashboard-main">
      <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
          <span id="last-updated">Last updated: --</span>
          <span id="connection-status" class="status-indicator">‚óè Connected</span>
        </div>

        <!-- Key Metrics -->
        <section class="metrics-grid">
          <div class="metric-card">
            <div class="metric-label">Total Views</div>
            <div class="metric-value" id="total-views">--</div>
            <div class="metric-change" id="views-change"></div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Unique Visitors</div>
            <div class="metric-value" id="unique-visitors">--</div>
            <div class="metric-change" id="visitors-change"></div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Bounce Rate</div>
            <div class="metric-value" id="bounce-rate">--</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Avg. Visit Duration</div>
            <div class="metric-value" id="avg-duration">--</div>
          </div>
        </section>

        <!-- LLM Traffic Section -->
        <section class="section">
          <h2>ü§ñ AI/LLM Traffic</h2>
          <div class="metrics-grid metrics-grid--3">
            <div class="metric-card metric-card--highlight">
              <div class="metric-label">llms.txt Views</div>
              <div class="metric-value" id="llms-txt-views">--</div>
            </div>
            <div class="metric-card metric-card--highlight">
              <div class="metric-label">Blog .md Views</div>
              <div class="metric-value" id="blog-md-views">--</div>
            </div>
            <div class="metric-card metric-card--highlight">
              <div class="metric-label">llms-full.txt Views</div>
              <div class="metric-value" id="llms-full-views">--</div>
            </div>
          </div>
        </section>

        <!-- Two Column Layout -->
        <div class="two-column">
          <!-- Top Pages -->
          <section class="section">
            <h2>Top Pages</h2>
            <div class="table-container">
              <table id="top-pages-table">
                <thead>
                  <tr>
                    <th>Page</th>
                    <th>Views</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody id="top-pages-body">
                  <tr><td colspan="3" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- Referrers -->
          <section class="section">
            <h2>Top Referrers</h2>
            <div class="table-container">
              <table id="referrers-table">
                <thead>
                  <tr>
                    <th>Source</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody id="referrers-body">
                  <tr><td colspan="2" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- More Stats -->
        <div class="two-column">
          <!-- Countries -->
          <section class="section">
            <h2>Countries</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody id="countries-body">
                  <tr><td colspan="2" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <!-- Devices -->
          <section class="section">
            <h2>Devices</h2>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>Device</th>
                    <th>Visitors</th>
                  </tr>
                </thead>
                <tbody id="devices-body">
                  <tr><td colspan="2" class="loading">Loading...</td></tr>
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Substack Stats -->
        <section class="section">
          <h2>üìù Substack Posts</h2>
          <div class="substack-stats">
            <div class="metric-card">
              <div class="metric-label">Total Posts</div>
              <div class="metric-value" id="substack-count">--</div>
            </div>
            <div class="substack-posts" id="substack-posts">
              <p class="loading">Loading posts...</p>
            </div>
          </div>
        </section>

        <!-- Setup Instructions (shown when not configured) -->
        <section class="section" id="setup-section" style="display: none;">
          <h2>‚öôÔ∏è Setup Required</h2>
          <div class="setup-card">
            <p>To see live analytics, complete the Umami setup:</p>
            <ol>
              <li>Sign up at <a href="https://cloud.umami.is" target="_blank">cloud.umami.is</a> (free tier: 10k events/month)</li>
              <li>Add your website and get your Website ID</li>
              <li>Add these secrets to your GitHub repo settings:
                <code>PUBLIC_UMAMI_WEBSITE_ID</code> and <code>PUBLIC_UMAMI_URL</code>
              </li>
              <li>Also add <code>UMAMI_API_KEY</code> for dashboard API access</li>
              <li>Redeploy your site</li>
            </ol>
            <p>See <code>ANALYTICS-SETUP.md</code> for detailed instructions.</p>
          </div>
        </section>
      </div>
    </main>
  </div>
</BaseLayout>

<style>
  /* Auth Screen */
  .auth-screen {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-bg-alt);
  }

  .auth-card {
    background: var(--color-bg);
    padding: var(--space-12);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-lg);
    text-align: center;
    max-width: 400px;
    width: 100%;
  }

  .auth-card h1 {
    font-size: var(--text-2xl);
    margin-bottom: var(--space-2);
  }

  .auth-card p {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-6);
  }

  .auth-card form {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .auth-card input {
    padding: var(--space-3) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: inherit;
  }

  .auth-card button {
    padding: var(--space-3) var(--space-6);
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: var(--radius-md);
    font-size: var(--text-base);
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: background var(--duration-fast) var(--ease);
  }

  .auth-card button:hover {
    background: var(--color-accent-hover);
  }

  .error {
    color: #e53e3e;
    font-size: var(--text-sm);
    margin-top: var(--space-4);
  }

  /* Dashboard */
  .dashboard {
    min-height: 100vh;
    background: var(--color-bg-alt);
  }

  .dashboard-header {
    background: var(--color-bg);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-6) 0;
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: var(--space-4);
  }

  .back-link {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .header-content h1 {
    font-size: var(--text-2xl);
    margin-top: var(--space-2);
  }

  .header-actions {
    display: flex;
    gap: var(--space-3);
    align-items: center;
  }

  .header-actions select {
    padding: var(--space-2) var(--space-4);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: inherit;
    font-size: var(--text-sm);
    background: var(--color-bg);
    cursor: pointer;
  }

  .btn-secondary {
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    font-family: inherit;
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--duration-fast) var(--ease);
  }

  .btn-secondary:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
  }

  .dashboard-main {
    padding: var(--space-8) 0;
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-6);
  }

  .status-indicator {
    color: #38a169;
  }

  .status-indicator.error {
    color: #e53e3e;
  }

  /* Metrics Grid */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-8);
  }

  .metrics-grid--3 {
    grid-template-columns: repeat(3, 1fr);
  }

  @media (max-width: 900px) {
    .metrics-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 500px) {
    .metrics-grid {
      grid-template-columns: 1fr;
    }
  }

  .metric-card {
    background: var(--color-bg);
    padding: var(--space-6);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
  }

  .metric-card--highlight {
    border-color: var(--color-accent);
    border-width: 2px;
  }

  .metric-label {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-tertiary);
    margin-bottom: var(--space-2);
  }

  .metric-value {
    font-size: var(--text-3xl);
    font-weight: 600;
    color: var(--color-text);
  }

  .metric-change {
    font-size: var(--text-sm);
    margin-top: var(--space-1);
  }

  .metric-change.positive {
    color: #38a169;
  }

  .metric-change.negative {
    color: #e53e3e;
  }

  /* Sections */
  .section {
    background: var(--color-bg);
    padding: var(--space-6);
    border-radius: var(--radius-md);
    border: 1px solid var(--color-border);
    margin-bottom: var(--space-6);
  }

  .section h2 {
    font-size: var(--text-lg);
    margin-bottom: var(--space-4);
  }

  .two-column {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  @media (max-width: 768px) {
    .two-column {
      grid-template-columns: 1fr;
    }
  }

  /* Tables */
  .table-container {
    overflow-x: auto;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: var(--text-sm);
  }

  th, td {
    padding: var(--space-3) var(--space-4);
    text-align: left;
    border-bottom: 1px solid var(--color-border);
  }

  th {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-tertiary);
    font-weight: 500;
  }

  td {
    color: var(--color-text);
  }

  td:last-child {
    text-align: right;
    font-family: var(--font-mono);
  }

  th:last-child {
    text-align: right;
  }

  .loading {
    color: var(--color-text-tertiary);
    font-style: italic;
  }

  /* Substack Stats */
  .substack-stats {
    display: grid;
    grid-template-columns: 150px 1fr;
    gap: var(--space-6);
    align-items: start;
  }

  @media (max-width: 600px) {
    .substack-stats {
      grid-template-columns: 1fr;
    }
  }

  .substack-posts {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .substack-post {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--color-bg-alt);
    border-radius: var(--radius-sm);
  }

  .substack-post-title {
    font-weight: 500;
  }

  .substack-post-date {
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
  }

  /* Setup Card */
  .setup-card {
    background: var(--color-bg-alt);
    padding: var(--space-6);
    border-radius: var(--radius-md);
  }

  .setup-card ol {
    margin: var(--space-4) 0;
    padding-left: var(--space-6);
  }

  .setup-card li {
    margin-bottom: var(--space-3);
  }

  .setup-card code {
    background: var(--color-surface);
    padding: 0.2em 0.4em;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: var(--text-sm);
  }

  .setup-card a {
    color: var(--color-accent);
    text-decoration: underline;
  }
</style>

<script>
  // Configuration
  const DASHBOARD_PASSWORD = 'travis2026'; // Change this!
  const UMAMI_API_URL = 'https://api.umami.is/v1';
  const UMAMI_WEBSITE_ID = 'c6cedcf7-fb2d-4ff2-bf5f-8a584da45fb6';
  const UMAMI_API_KEY = 'api_4u21H1bmxzBX1D5uo0y3K3HstHNO1O9r';
  
  // Cache key
  const CACHE_KEY = 'portfolio_analytics_cache';
  const AUTH_KEY = 'portfolio_dashboard_auth';

  // Elements
  const authScreen = document.getElementById('auth-screen')!;
  const dashboard = document.getElementById('dashboard')!;
  const authForm = document.getElementById('auth-form')!;
  const authError = document.getElementById('auth-error')!;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const dateRange = document.getElementById('date-range') as HTMLSelectElement;
  const refreshBtn = document.getElementById('refresh-btn')!;
  const logoutBtn = document.getElementById('logout-btn')!;
  const setupSection = document.getElementById('setup-section')!;

  // Check auth on load
  function checkAuth(): boolean {
    const stored = sessionStorage.getItem(AUTH_KEY);
    return stored === 'true';
  }

  // Show dashboard or auth
  function initAuth() {
    if (checkAuth()) {
      showDashboard();
    } else {
      authScreen.style.display = 'flex';
      dashboard.style.display = 'none';
    }
  }

  // Handle login
  authForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (passwordInput.value === DASHBOARD_PASSWORD) {
      sessionStorage.setItem(AUTH_KEY, 'true');
      showDashboard();
    } else {
      authError.textContent = 'Incorrect password';
      passwordInput.value = '';
    }
  });

  // Logout
  logoutBtn.addEventListener('click', () => {
    sessionStorage.removeItem(AUTH_KEY);
    authScreen.style.display = 'flex';
    dashboard.style.display = 'none';
    passwordInput.value = '';
    authError.textContent = '';
  });

  // Show dashboard
  function showDashboard() {
    authScreen.style.display = 'none';
    dashboard.style.display = 'block';
    
    // Check if Umami is configured
    if (!UMAMI_WEBSITE_ID) {
      setupSection.style.display = 'block';
      loadDemoData();
    } else {
      loadAnalytics();
    }
    
    // Always load Substack data
    loadSubstackData();
  }

  // Get date range
  function getDateRange(): { startAt: number; endAt: number } {
    const now = Date.now();
    const ranges: Record<string, number> = {
      '24h': 24 * 60 * 60 * 1000,
      '7d': 7 * 24 * 60 * 60 * 1000,
      '30d': 30 * 24 * 60 * 60 * 1000,
      '90d': 90 * 24 * 60 * 60 * 1000,
    };
    const range = ranges[dateRange.value] || ranges['7d'];
    return {
      startAt: now - range,
      endAt: now,
    };
  }

  // Format numbers
  function formatNumber(num: number): string {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toString();
  }

  // Format duration
  function formatDuration(seconds: number): string {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins}m ${secs}s`;
  }

  // Load demo data when Umami isn't configured
  function loadDemoData() {
    document.getElementById('total-views')!.textContent = '1,234';
    document.getElementById('unique-visitors')!.textContent = '567';
    document.getElementById('bounce-rate')!.textContent = '42%';
    document.getElementById('avg-duration')!.textContent = '2m 34s';
    document.getElementById('views-change')!.innerHTML = '<span class="positive">‚Üë 12%</span>';
    document.getElementById('visitors-change')!.innerHTML = '<span class="positive">‚Üë 8%</span>';
    
    document.getElementById('llms-txt-views')!.textContent = '89';
    document.getElementById('blog-md-views')!.textContent = '156';
    document.getElementById('llms-full-views')!.textContent = '34';
    
    document.getElementById('top-pages-body')!.innerHTML = `
      <tr><td>/</td><td>456</td><td>234</td></tr>
      <tr><td>/work/shopify</td><td>234</td><td>178</td></tr>
      <tr><td>/about</td><td>189</td><td>145</td></tr>
      <tr><td>/blog</td><td>156</td><td>98</td></tr>
      <tr><td>/work/grubhub-onboarding</td><td>123</td><td>89</td></tr>
    `;
    
    document.getElementById('referrers-body')!.innerHTML = `
      <tr><td>linkedin.com</td><td>123</td></tr>
      <tr><td>twitter.com</td><td>89</td></tr>
      <tr><td>google.com</td><td>67</td></tr>
      <tr><td>substack.com</td><td>45</td></tr>
      <tr><td>(direct)</td><td>234</td></tr>
    `;
    
    document.getElementById('countries-body')!.innerHTML = `
      <tr><td>üá∫üá∏ United States</td><td>345</td></tr>
      <tr><td>üá¨üáß United Kingdom</td><td>67</td></tr>
      <tr><td>üá®üá¶ Canada</td><td>45</td></tr>
      <tr><td>üá©üá™ Germany</td><td>34</td></tr>
      <tr><td>üá´üá∑ France</td><td>23</td></tr>
    `;
    
    document.getElementById('devices-body')!.innerHTML = `
      <tr><td>Desktop</td><td>389</td></tr>
      <tr><td>Mobile</td><td>156</td></tr>
      <tr><td>Tablet</td><td>22</td></tr>
    `;
    
    document.getElementById('last-updated')!.textContent = `Last updated: ${new Date().toLocaleTimeString()} (demo data)`;
  }

  // Load real analytics from Umami API
  async function loadAnalytics() {
    const { startAt, endAt } = getDateRange();
    const statusEl = document.getElementById('connection-status')!;
    
    try {
      // Note: Umami Cloud API requires authentication
      // For a static site, you'd need to proxy through a serverless function
      // or use the share URL embed feature
      
      const headers = {
        'x-umami-api-key': UMAMI_API_KEY,
        'Content-Type': 'application/json',
      };

      // Fetch stats
      const statsRes = await fetch(
        `${UMAMI_API_URL}/websites/${UMAMI_WEBSITE_ID}/stats?startAt=${startAt}&endAt=${endAt}`,
        { headers }
      );
      
      if (!statsRes.ok) throw new Error('Failed to fetch stats');
      
      const stats = await statsRes.json();
      
      document.getElementById('total-views')!.textContent = formatNumber(stats.pageviews?.value || 0);
      document.getElementById('unique-visitors')!.textContent = formatNumber(stats.visitors?.value || 0);
      document.getElementById('bounce-rate')!.textContent = `${Math.round(stats.bounces?.value / stats.visits?.value * 100) || 0}%`;
      document.getElementById('avg-duration')!.textContent = formatDuration(stats.totaltime?.value / stats.visits?.value || 0);

      // Fetch pages
      const pagesRes = await fetch(
        `${UMAMI_API_URL}/websites/${UMAMI_WEBSITE_ID}/metrics?startAt=${startAt}&endAt=${endAt}&type=url`,
        { headers }
      );
      
      if (pagesRes.ok) {
        const pages = await pagesRes.json();
        const pagesHtml = pages.slice(0, 10).map((p: any) => 
          `<tr><td>${p.x}</td><td>${p.y}</td><td>--</td></tr>`
        ).join('');
        document.getElementById('top-pages-body')!.innerHTML = pagesHtml || '<tr><td colspan="3">No data</td></tr>';
        
        // Calculate LLM traffic
        const llmsTxt = pages.find((p: any) => p.x === '/llms.txt')?.y || 0;
        const llmsFull = pages.find((p: any) => p.x === '/llms-full.txt')?.y || 0;
        const blogMd = pages.filter((p: any) => p.x.endsWith('.md') && p.x.includes('/blog/')).reduce((sum: number, p: any) => sum + p.y, 0);
        
        document.getElementById('llms-txt-views')!.textContent = formatNumber(llmsTxt);
        document.getElementById('llms-full-views')!.textContent = formatNumber(llmsFull);
        document.getElementById('blog-md-views')!.textContent = formatNumber(blogMd);
      }

      // Fetch referrers
      const refRes = await fetch(
        `${UMAMI_API_URL}/websites/${UMAMI_WEBSITE_ID}/metrics?startAt=${startAt}&endAt=${endAt}&type=referrer`,
        { headers }
      );
      
      if (refRes.ok) {
        const refs = await refRes.json();
        const refsHtml = refs.slice(0, 10).map((r: any) => 
          `<tr><td>${r.x || '(direct)'}</td><td>${r.y}</td></tr>`
        ).join('');
        document.getElementById('referrers-body')!.innerHTML = refsHtml || '<tr><td colspan="2">No data</td></tr>';
      }

      // Fetch countries
      const countryRes = await fetch(
        `${UMAMI_API_URL}/websites/${UMAMI_WEBSITE_ID}/metrics?startAt=${startAt}&endAt=${endAt}&type=country`,
        { headers }
      );
      
      if (countryRes.ok) {
        const countries = await countryRes.json();
        const countriesHtml = countries.slice(0, 5).map((c: any) => 
          `<tr><td>${c.x}</td><td>${c.y}</td></tr>`
        ).join('');
        document.getElementById('countries-body')!.innerHTML = countriesHtml || '<tr><td colspan="2">No data</td></tr>';
      }

      // Fetch devices
      const deviceRes = await fetch(
        `${UMAMI_API_URL}/websites/${UMAMI_WEBSITE_ID}/metrics?startAt=${startAt}&endAt=${endAt}&type=device`,
        { headers }
      );
      
      if (deviceRes.ok) {
        const devices = await deviceRes.json();
        const devicesHtml = devices.slice(0, 5).map((d: any) => 
          `<tr><td>${d.x}</td><td>${d.y}</td></tr>`
        ).join('');
        document.getElementById('devices-body')!.innerHTML = devicesHtml || '<tr><td colspan="2">No data</td></tr>';
      }

      document.getElementById('last-updated')!.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
      statusEl.textContent = '‚óè Connected';
      statusEl.classList.remove('error');
      
    } catch (error) {
      console.error('Failed to load analytics:', error);
      statusEl.textContent = '‚óè Connection error';
      statusEl.classList.add('error');
      loadDemoData();
    }
  }

  // Load Substack data from cache
  async function loadSubstackData() {
    try {
      const res = await fetch('/src/data/posts-cache.json');
      if (res.ok) {
        const data = await res.json();
        const posts = data.posts || [];
        
        document.getElementById('substack-count')!.textContent = posts.length.toString();
        
        const postsHtml = posts.slice(0, 5).map((post: any) => `
          <div class="substack-post">
            <span class="substack-post-title">${post.title}</span>
            <span class="substack-post-date">${new Date(post.date).toLocaleDateString()}</span>
          </div>
        `).join('');
        
        document.getElementById('substack-posts')!.innerHTML = postsHtml || '<p>No posts yet</p>';
      }
    } catch (error) {
      // Try the API endpoint instead
      try {
        const res = await fetch('/llms.txt');
        if (res.ok) {
          const text = await res.text();
          const postMatches = text.match(/## Writing[\s\S]*?## Optional/);
          if (postMatches) {
            const postLines = postMatches[0].split('\n').filter(l => l.startsWith('- ['));
            document.getElementById('substack-count')!.textContent = postLines.length.toString();
          }
        }
      } catch {
        document.getElementById('substack-count')!.textContent = '--';
      }
    }
  }

  // Event listeners
  dateRange.addEventListener('change', () => {
    if (UMAMI_WEBSITE_ID && UMAMI_API_KEY) {
      loadAnalytics();
    }
  });

  refreshBtn.addEventListener('click', () => {
    if (UMAMI_WEBSITE_ID && UMAMI_API_KEY) {
      loadAnalytics();
    } else {
      loadDemoData();
    }
    loadSubstackData();
  });

  // Auto-refresh every 5 minutes
  setInterval(() => {
    if (checkAuth()) {
      if (UMAMI_WEBSITE_ID && UMAMI_API_KEY) {
        loadAnalytics();
      }
      loadSubstackData();
    }
  }, 5 * 60 * 1000);

  // Initialize
  initAuth();
</script>
